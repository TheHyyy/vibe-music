# 解决方案：修复成员同步异常与搜索无响应问题

在修复了 Host 权限丢失问题后，我们将重点解决剩余的两个核心问题：**成员同步异常 (Issue 2)** 和 **搜索无响应 (Issue 4)**。

## 问题分析与修复策略

### 1. 成员同步异常 (Member Sync - Issue 2)
*   **根本原因 (Root Cause)**: 服务端 `removeMember` 逻辑过于激进。当用户刷新页面时，Socket 会短暂断开，触发 `disconnect` 事件，导致服务端立即移除该成员。然而，新的连接 (`joinRoom`) 可能紧随其后甚至并发发生，导致由于竞争条件 (Race Condition) 使得用户被错误移除或状态不一致。
*   **修复方案**: 引入 **"优雅断开" (Graceful Disconnection)** 机制。
    *   **延迟移除**: 在收到 `disconnect` 事件时，不立即移除成员，而是启动一个 5 秒的定时器。
    *   **重连取消**: 如果同一用户在定时器结束前重新连接 (`joinRoom`)，则取消待执行的移除操作。
    *   **效果**: 这将彻底解决刷新页面导致的成员列表闪烁和同步错误。

### 2. 搜索/点歌无响应 (Search No Response - Issue 4)
*   **根本原因 (Root Cause)**: 后端音乐搜索聚合层 (`searchMusic`) 缺乏超时控制。如果第三方 API (网易云/QQ) 响应缓慢或挂起，整个搜索请求会一直处于 Pending 状态，导致前端看起来“无响应”。
*   **修复方案**: 为搜索请求添加 **超时熔断** 机制。
    *   **超时控制**: 在 `server/src/music/service.ts` 中，为每个搜索源设置 10 秒超时限制。
    *   **部分返回**: 即使某个源超时，仍返回其他源的搜索结果，而不是让整个请求失败。

## 执行计划

### 第一步：后端成员管理优化
1.  **修改 `server/src/store.ts`**:
    *   添加 `scheduleLeave(roomId, userId)` 和 `cancelLeave(roomId, userId)` 方法。
    *   使用内存 `Map` 维护待移除的定时器。
2.  **修改 `server/src/index.ts`**:
    *   在 `socket.on("disconnect")` 中调用 `scheduleLeave` 而非直接 `removeMember`。
    *   在 `socket.on("room:join")` 中调用 `cancelLeave` 确保重连用户保持在线。

### 第二步：后端搜索优化
1.  **修改 `server/src/music/service.ts`**:
    *   引入 `Promise.race` 实现 10 秒超时控制。
    *   优化错误日志，明确指出哪个源超时。

### 第三步：验证
1.  **验证同步**: 刷新 Host 页面，观察 GuestB 端成员列表是否保持稳定（不再瞬间减少）。
2.  **验证搜索**: 模拟网络延迟或直接测试搜索功能，确保 10 秒内必然返回结果（或空数组）。